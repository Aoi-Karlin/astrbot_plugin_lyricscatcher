# Lyric Trigger 插件

一个智能歌词触发插件，当用户发送指令和歌词时，自动获取下一句歌词并静默触发AI回复。

## 功能特点

- 🎵 **智能歌词识别**：通过指令触发歌词搜索和匹配
- 🔍 **模糊匹配**：支持相似度匹配，不要求完全一致
- 💬 **静默触发**：匹配成功后直接触发LLM回复，无中间提示
- ⚙️ **灵活配置**：支持通过WebUI调整各项参数
- 🛡️ **API保护**：按需触发，避免API过载

## 安装要求

1. 部署 [NeteaseCloudMusicApi](https://github.com/Binaryify/NeteaseCloudMusicApi) 服务
2. 确保AstrBot可以访问该API服务
3. 将本插件放入AstrBot的插件目录

## 配置说明

在AstrBot WebUI中可以配置以下参数：

### 网易云API地址
- **说明**：NeteaseCloudMusicApi服务的地址
- **默认值**：`http://127.0.0.1:3000`
- **示例**：`http://your-server:3000`

### 最低触发匹配度
- **说明**：歌词相似度阈值，范围0.0-1.0
- **默认值**：`0.6`
- **范围**：0.1-1.0（步长0.05）
- **建议**：
  - 0.5-0.6：较宽松，容易触发
  - 0.7-0.8：较严格，匹配更精确

### 最大搜索结果数
- **说明**：每次搜索时检查的歌曲数量
- **默认值**：`5`
- **范围**：1-20
- **建议**：数值越大匹配概率越高，但响应速度可能变慢

### 触发提示词
- **说明**：匹配成功后发送给LLM的提示词模板
- **默认值**：包含歌词和提示的模板
- **可用变量**：
  - `{lyric}`：用户输入的当前歌词
  - `{next_line}`：下一句歌词
  - `{song_name}`：歌曲名称

## 使用方法

### 触发指令

使用以下任一指令触发歌词匹配：

- `/歌词匹配 <歌词内容>`
- `/lyric <歌词内容>`
- `/匹配歌词 <歌词内容>`
- `/lyricmatch <歌词内容>`

### 使用示例

**输入：**
```
/歌词匹配 天青色等烟雨
```

**AI回复（静默触发，直接显示AI回复）：**
```
月色被打捞起，晕开了结局。这句歌词真美，让人想起江南水乡的朦胧诗意。
```

**匹配失败时：**
```
❌ 未找到匹配的歌词。

可能的原因：
• 相似度低于阈值（当前：0.6）
• 未在搜索结果中找到匹配歌曲
• 歌词内容可能不够独特

建议：尝试更长的歌词片段或调整配置参数。
```

## 工作原理

1. 用户发送指令+歌词内容
2. 调用网易云API搜索相关歌曲（`/search?keywords=xxx`）
3. 对每首歌曲获取歌词（`/lyric?id=SongID`）
4. 使用相似度算法匹配歌词
5. 如果匹配成功（相似度≥阈值），静默获取下一句歌词
6. 构造提示词并静默发送给LLM
7. LLM生成回复并显示（用户只看到AI回复）

## 示例场景

**场景1：成功匹配**
```
用户：/歌词匹配 天青色等烟雨
AI：而我在等你，月色被打捞起...
```

**场景2：模糊匹配**
```
用户：/歌词匹配 天青色等烟雨而我在等你
AI：炊烟袅袅升起，隔江千万里...
```

**场景3：未找到匹配**
```
用户：/歌词匹配 这是一句普通的聊天
插件：❌ 未找到匹配的歌词。
```

## 注意事项

- 需要确保NeteaseCloudMusicApi服务正常运行
- 歌词匹配基于相似度算法，不要求完全一致
- 插件会消耗LLM的API调用次数
- 建议在配置中适当调整阈值以平衡准确率和召回率
- 每次调用会搜索多首歌曲，请根据API性能调整最大搜索结果数
- 插件采用静默触发模式，成功后用户只会看到AI回复

## 故障排除

**问题：插件无法触发**
- 检查API地址是否正确
- 检查相似度阈值设置
- 查看日志确认是否有错误信息
- 确认NeteaseCloudMusicApi服务可访问

**问题：匹配不准确**
- 尝试降低相似度阈值
- 增加最大搜索结果数
- 检查网络连接是否稳定
- 确认歌词内容是否正确

**问题：响应慢**
- 减少最大搜索结果数
- 检查NeteaseCloudMusicApi服务响应速度
- 考虑使用更快的网络环境
- 查看服务器资源使用情况

**问题：API调用失败**
- 检查NeteaseCloudMusicApi服务状态
- 确认API端口是否开放
- 查看服务日志排查问题
- 考虑增加API调用超时时间

## 静默触发说明

本插件采用**静默触发**模式：
- ✅ 匹配成功：直接触发LLM回复，用户只看到AI的回复内容
- ❌ 匹配失败：显示错误提示，帮助用户了解原因
- 📝 日志记录：所有匹配和触发操作都会记录在日志中

这种模式提供了更自然的对话体验，让AI回复看起来像是直接理解了歌词含义。

## 更新日志

### v1.0.0
- 初始版本发布
- 实现指令触发的歌词匹配功能
- 支持模糊匹配和静默AI回复触发
- 提供完整的WebUI配置界面
